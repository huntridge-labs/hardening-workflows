name: Reusable Security Hardening Pipeline

on:
  workflow_call:
    inputs:
      scanners:
        description: 'Comma-separated list of scanners to run (codeql, opengrep, bandit, gitleaks, container, infrastructure, lint, all, sast, secrets, etc.)'
        required: false
        default: 'all'
        type: string
      scan_type:
        description: '(Deprecated) Legacy scan type selector. Prefer the scanners input.'
        required: false
        default: ''
        type: string
      python_version:
        description: 'Python version to use'
        required: false
        default: '3.12'
        type: string
      aws_region:
        description: 'AWS region for infrastructure scans'
        required: false
        default: 'us-east-1'
        type: string
      iac_path:
        description: 'Directory that contains infrastructure-as-code (Terraform) files'
        required: false
        default: 'infrastructure'
        type: string
      post_pr_comment:
        description: 'Whether to post PR comments'
        required: false
        default: true
        type: boolean
      codeql_languages:
        description: 'Comma-separated list of languages for CodeQL analysis (e.g., "python,javascript" or "python")'
        required: false
        default: 'python,javascript'
        type: string
      enable_code_security:
        description: 'Whether GitHub Code Security is enabled for this repository (required for CodeQL scanning)'
        required: false
        default: false
        type: boolean
    secrets:
      AWS_ACCOUNT_ID:
        description: 'AWS Account ID for infrastructure scans'
        required: false

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write
  checks: write
  id-token: write

env:
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  AWS_REGION: ${{ inputs.aws_region }}
  PYTHON_VERSION: ${{ inputs.python_version }}

jobs:
  scan-coordinator:
    name: Scan Coordinator
    runs-on: ubuntu-latest
    if: ${{ !cancelled() }}
    outputs:
      selected_scanners: ${{ steps.resolve.outputs.selected_scanners }}
      selected_scanners_json: ${{ steps.resolve.outputs.selected_scanners_json }}
      run_codeql: ${{ steps.resolve.outputs.run_codeql }}
      run_opengrep: ${{ steps.resolve.outputs.run_opengrep }}
      run_bandit: ${{ steps.resolve.outputs.run_bandit }}
      run_gitleaks: ${{ steps.resolve.outputs.run_gitleaks }}
      run_container: ${{ steps.resolve.outputs.run_container }}
      run_infrastructure: ${{ steps.resolve.outputs.run_infrastructure }}
      run_lint: ${{ steps.resolve.outputs.run_lint }}
      run_any: ${{ steps.resolve.outputs.run_any }}

    steps:
    - name: Resolve scanner selection
      id: resolve
      shell: bash
      run: |
        set -euo pipefail

        declare -A RUN=(
          [codeql]=false
          [opengrep]=false
          [bandit]=false
          [gitleaks]=false
          [container]=false
          [infrastructure]=false
          [lint]=false
        )

        DEFAULT_SCANNERS=(codeql opengrep bandit gitleaks container infrastructure)
        SELECTED=()

        normalize() {
          echo "$1" | tr '[:upper:]' '[:lower:]' | tr -d ' \t' | tr '_' '-'
        }

        add_scanner() {
          local key="$1"
          if [[ -z "${RUN[$key]+_}" ]]; then
            echo "::notice title=Unknown scanner token::Scanner '$key' is not recognized and will be ignored."
            return
          fi
          if [[ "${RUN[$key]}" != "true" ]]; then
            RUN[$key]=true
            SELECTED+=("$key")
          fi
        }

        reset_selection() {
          SELECTED=()
          for key in "${!RUN[@]}"; do
            RUN[$key]=false
          done
        }

        apply_token() {
          local token="$1"
          case "$token" in
            '' ) ;;
            all|full)
              for key in "${DEFAULT_SCANNERS[@]}"; do add_scanner "$key"; done
              ;;
            sast|sast-only)
              for key in codeql opengrep bandit gitleaks; do add_scanner "$key"; done
              ;;
            secrets|secrets-only)
              add_scanner gitleaks
              ;;
            codeql|code-ql)
              add_scanner codeql
              ;;
            semgrep|opengrep|open-grep)
              add_scanner opengrep
              ;;
            bandit)
              add_scanner bandit
              ;;
            gitleaks|git-leaks)
              add_scanner gitleaks
              ;;
            container|containers|container-scan|docker)
              add_scanner container
              ;;
            infrastructure|infra|iac|terraform)
              add_scanner infrastructure
              ;;
            lint|linting|code-quality)
              add_scanner lint
              ;;
            none|off)
              reset_selection
              ;;
            *)
              echo "::notice title=Unknown scanner token::Value '$token' is not recognized and will be ignored."
              ;;
          esac
        }

        SCANNERS_RAW="${{ inputs.scanners }}"
        SCAN_TYPE_RAW="$(normalize "${{ inputs.scan_type }}")"

        if [[ -z "$SCANNERS_RAW" || "$SCANNERS_RAW" == "default" ]]; then
          case "$SCAN_TYPE_RAW" in
            codeql-only)
              SCANNERS_RAW='codeql'
              ;;
            sast-only)
              SCANNERS_RAW='sast'
              ;;
            container-only)
              SCANNERS_RAW='container'
              ;;
            infrastructure-only)
              SCANNERS_RAW='infrastructure'
              ;;
            full|'')
              SCANNERS_RAW='all'
              ;;
            *)
              echo "::notice title=Unknown legacy scan type::Scan type '$SCAN_TYPE_RAW' not recognized. Falling back to 'all'."
              SCANNERS_RAW='all'
              ;;
          esac
        fi

        IFS=',' read -ra TOKENS <<< "$SCANNERS_RAW"
        for raw in "${TOKENS[@]}"; do
          apply_token "$(normalize "$raw")"
        done

        if [[ ${#SELECTED[@]} -eq 0 ]]; then
          for key in "${DEFAULT_SCANNERS[@]}"; do add_scanner "$key"; done
        fi

        RUN_ANY=false
        for key in "${!RUN[@]}"; do
          if [[ "${RUN[$key]}" == "true" ]]; then
            RUN_ANY=true
          fi
          echo "run_${key}=${RUN[$key]}" >> "$GITHUB_OUTPUT"
        done

        if [[ "$RUN_ANY" == "false" ]]; then
          echo "::warning title=No scanners selected::No scanners were selected. The workflow will execute the summary only."
        fi

        # Check GitHub Code Security integration
        ENABLE_CODE_SECURITY="${{ inputs.enable_code_security }}"
        if [[ "${RUN[codeql]}" == "true" && "$ENABLE_CODE_SECURITY" != "true" ]]; then
          echo "::warning title=CodeQL Disabled::GitHub Code Security is not enabled for this repository. CodeQL scanning will be skipped."
          RUN[codeql]=false
          # Remove codeql from SELECTED array
          SELECTED=("${SELECTED[@]/codeql}")
        fi

        echo "run_any=$RUN_ANY" >> "$GITHUB_OUTPUT"

        SELECTED_STR=$(IFS=','; echo "${SELECTED[*]}")
        if [[ -z "$SELECTED_STR" ]]; then
          SELECTED_STR=""
        fi

        if [[ ${#SELECTED[@]} -eq 0 ]]; then
          SELECTED_JSON='[]'
        else
          SELECTED_JSON='['
          for item in "${SELECTED[@]}"; do
            SELECTED_JSON+="\"$item\","
          done
          SELECTED_JSON="${SELECTED_JSON%,}]"
        fi

        echo "selected_scanners=$SELECTED_STR" >> "$GITHUB_OUTPUT"
        echo "selected_scanners_json=$SELECTED_JSON" >> "$GITHUB_OUTPUT"

        echo ""
        echo "ÔøΩ Resolved scanners: ${SELECTED_STR:-none}"
        echo "üìå Legacy scan_type input: ${SCAN_TYPE_RAW:-'<not provided>'}"

  code-quality-linting:
    name: Code Quality & Linting
    needs: scan-coordinator
    if: needs.scan-coordinator.outputs.run_lint == 'true'
    uses: ./.github/workflows/linting.yml
    permissions:
      contents: read
      pull-requests: write
      checks: write

  scanner-codeql:
    name: CodeQL Scanner
    needs: scan-coordinator
    if: needs.scan-coordinator.outputs.run_codeql == 'true'
    uses: ./.github/workflows/scanner-codeql.yml
    with:
      codeql_languages: ${{ inputs.codeql_languages }}
      post_pr_comment: ${{ inputs.post_pr_comment }}
      enable_code_security: ${{ inputs.enable_code_security }}
    permissions:
      contents: read
      security-events: write
      actions: read
      pull-requests: write
    secrets: inherit

  scanner-opengrep:
    name: OpenGrep Scanner
    needs: scan-coordinator
    if: needs.scan-coordinator.outputs.run_opengrep == 'true'
    uses: ./.github/workflows/scanner-opengrep.yml
    with:
      post_pr_comment: ${{ inputs.post_pr_comment }}
      enable_code_security: ${{ inputs.enable_code_security }}
    permissions:
      contents: read
      security-events: write
      actions: read
      pull-requests: write
    secrets: inherit

  scanner-bandit:
    name: Bandit Scanner
    needs: scan-coordinator
    if: needs.scan-coordinator.outputs.run_bandit == 'true'
    uses: ./.github/workflows/scanner-bandit.yml
    with:
      post_pr_comment: ${{ inputs.post_pr_comment }}
      enable_code_security: ${{ inputs.enable_code_security }}
    permissions:
      contents: read
      security-events: write
      actions: read
      pull-requests: write
    secrets: inherit

  scanner-gitleaks:
    name: Gitleaks Scanner
    needs: scan-coordinator
    if: needs.scan-coordinator.outputs.run_gitleaks == 'true'
    uses: ./.github/workflows/scanner-gitleaks.yml
    with:
      post_pr_comment: ${{ inputs.post_pr_comment }}
      enable_code_security: ${{ inputs.enable_code_security }}
    permissions:
      contents: read
      security-events: write
      actions: read
      pull-requests: write
    secrets: inherit

  scanner-container:
    name: Container Scanner
    needs: scan-coordinator
    if: needs.scan-coordinator.outputs.run_container == 'true'
    uses: ./.github/workflows/container-scan.yml
    with:
      post_pr_comment: ${{ inputs.post_pr_comment }}
      enable_code_security: ${{ inputs.enable_code_security }}
    permissions:
      contents: read
      security-events: write
      actions: read
      pull-requests: write
    secrets: inherit

  scanner-infrastructure:
    name: Infrastructure Scanner
    needs: scan-coordinator
    if: needs.scan-coordinator.outputs.run_infrastructure == 'true'
    uses: ./.github/workflows/infrastructure.yml
    with:
      iac_path: ${{ inputs.iac_path }}
      python_version: ${{ inputs.python_version }}
      aws_region: ${{ inputs.aws_region }}
      enable_code_security: ${{ inputs.enable_code_security }}
    permissions:
      contents: read
      security-events: write
      actions: read
      pull-requests: write
    secrets: inherit

  security-summary:
    name: Security Hardening Summary
    runs-on: ubuntu-latest
    needs:
      - scan-coordinator
      - code-quality-linting
      - scanner-codeql
      - scanner-opengrep
      - scanner-bandit
      - scanner-gitleaks
      - scanner-container
      - scanner-infrastructure
    if: always()

    steps:
    - name: Download CodeQL artifacts
      if: needs.scan-coordinator.outputs.run_codeql == 'true'
      uses: actions/download-artifact@v5
      with:
        pattern: codeql-*
      continue-on-error: true

    - name: Download OpenGrep artifacts
      if: needs.scan-coordinator.outputs.run_opengrep == 'true'
      uses: actions/download-artifact@v5
      with:
        pattern: opengrep-*
      continue-on-error: true

    - name: Download Bandit artifacts
      if: needs.scan-coordinator.outputs.run_bandit == 'true'
      uses: actions/download-artifact@v5
      with:
        pattern: bandit-*
      continue-on-error: true

    - name: Download GitLeaks artifacts
      if: needs.scan-coordinator.outputs.run_gitleaks == 'true'
      uses: actions/download-artifact@v5
      with:
        pattern: gitleaks-*
      continue-on-error: true

    - name: Download Container artifacts
      if: needs.scan-coordinator.outputs.run_container == 'true'
      uses: actions/download-artifact@v5
      with:
        pattern: container-*
      continue-on-error: true

    - name: Download Infrastructure artifacts
      if: needs.scan-coordinator.outputs.run_infrastructure == 'true'
      uses: actions/download-artifact@v5
      with:
        pattern: infrastructure-*
      continue-on-error: true

    - name: Download Linting artifacts
      if: needs.scan-coordinator.outputs.run_lint == 'true'
      uses: actions/download-artifact@v5
      with:
        pattern: '*lint*'
      continue-on-error: true

    - name: Initialize security report
      run: |
        echo "# üõ°Ô∏è Security Analysis Summary" > security-hardening-report.md
        echo "" >> security-hardening-report.md
        echo "**Repository:** ${{ github.repository }}" >> security-hardening-report.md
        echo "**Branch:** ${{ github.ref_name }}" >> security-hardening-report.md
        echo "**Generated:** $(date)" >> security-hardening-report.md
        echo "" >> security-hardening-report.md

    - name: Parse CodeQL results
      if: needs.scan-coordinator.outputs.run_codeql == 'true'
      run: |
        echo "<details>" >> security-hardening-report.md
        echo "<summary>ÔøΩ CodeQL</summary>" >> security-hardening-report.md
        echo "" >> security-hardening-report.md

        if [ -d "codeql-reports" ] || compgen -G "codeql-reports-*" > /dev/null 2>&1; then
          echo "**Status:** ‚úÖ Completed" >> security-hardening-report.md
          echo "" >> security-hardening-report.md

          # Count issues from SARIF files
          ISSUE_COUNT=0
          CRITICAL_COUNT=0
          HIGH_COUNT=0
          MEDIUM_COUNT=0
          LOW_COUNT=0

          for sarif_file in $(find . -path "./codeql-reports*" -name "*.sarif" -type f 2>/dev/null); do
            if [ -f "$sarif_file" ] && [ -s "$sarif_file" ] && command -v jq >/dev/null 2>&1; then
              issues=$(jq -r '.runs[]?.results[]? | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              ISSUE_COUNT=$((ISSUE_COUNT + issues))

              critical=$(jq -r '.runs[]?.results[]? | select(.level == "error") | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              CRITICAL_COUNT=$((CRITICAL_COUNT + critical))

              high=$(jq -r '.runs[]?.results[]? | select(.level == "warning") | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              HIGH_COUNT=$((HIGH_COUNT + high))

              medium=$(jq -r '.runs[]?.results[]? | select(.level == "note") | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              MEDIUM_COUNT=$((MEDIUM_COUNT + medium))

              low=$(jq -r '.runs[]?.results[]? | select(.level == "info") | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              LOW_COUNT=$((LOW_COUNT + low))
            fi
          done

          echo "**Issues Found:** $ISSUE_COUNT" >> security-hardening-report.md
          echo "" >> security-hardening-report.md

          if [ $ISSUE_COUNT -gt 0 ]; then
            echo "| Severity | Count |" >> security-hardening-report.md
            echo "|----------|-------|" >> security-hardening-report.md
            [ $CRITICAL_COUNT -gt 0 ] && echo "| üî¥ Critical | $CRITICAL_COUNT |" >> security-hardening-report.md
            [ $HIGH_COUNT -gt 0 ] && echo "| üü† High | $HIGH_COUNT |" >> security-hardening-report.md
            [ $MEDIUM_COUNT -gt 0 ] && echo "| üü° Medium | $MEDIUM_COUNT |" >> security-hardening-report.md
            [ $LOW_COUNT -gt 0 ] && echo "| üîµ Low | $LOW_COUNT |" >> security-hardening-report.md
            echo "" >> security-hardening-report.md
          fi

          echo "**üìÅ Artifacts:** [CodeQL Reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)" >> security-hardening-report.md
        else
          echo "**Status:** ‚è≠Ô∏è Skipped" >> security-hardening-report.md
        fi

        echo "" >> security-hardening-report.md
        echo "</details>" >> security-hardening-report.md
        echo "" >> security-hardening-report.md
      continue-on-error: true

    - name: Parse OpenGrep results
      if: needs.scan-coordinator.outputs.run_opengrep == 'true'
      run: |
        echo "<details>" >> security-hardening-report.md
        echo "<summary>üîç OpenGrep</summary>" >> security-hardening-report.md
        echo "" >> security-hardening-report.md

        if [ -d "opengrep-reports" ]; then
          echo "**Status:** ‚úÖ Completed" >> security-hardening-report.md
          echo "" >> security-hardening-report.md

          # Count issues from JSON files (OpenGrep uses JSON, not SARIF)
          ISSUE_COUNT=0
          ERROR_COUNT=0
          WARNING_COUNT=0
          INFO_COUNT=0

          for json_file in $(find ./opengrep-reports -name "*.json" -type f 2>/dev/null); do
            if [ -f "$json_file" ] && [ -s "$json_file" ] && command -v jq >/dev/null 2>&1; then
              issues=$(jq -r '.results[]? | .check_id' "$json_file" 2>/dev/null | wc -l | tr -d ' ')
              ISSUE_COUNT=$((ISSUE_COUNT + issues))

              errors=$(jq -r '.results[]? | select(.extra.severity == "ERROR") | .check_id' "$json_file" 2>/dev/null | wc -l | tr -d ' ')
              ERROR_COUNT=$((ERROR_COUNT + errors))

              warnings=$(jq -r '.results[]? | select(.extra.severity == "WARNING") | .check_id' "$json_file" 2>/dev/null | wc -l | tr -d ' ')
              WARNING_COUNT=$((WARNING_COUNT + warnings))

              infos=$(jq -r '.results[]? | select(.extra.severity == "INFO") | .check_id' "$json_file" 2>/dev/null | wc -l | tr -d ' ')
              INFO_COUNT=$((INFO_COUNT + infos))
            fi
          done

          echo "**Issues Found:** $ISSUE_COUNT" >> security-hardening-report.md
          echo "" >> security-hardening-report.md

          if [ $ISSUE_COUNT -gt 0 ]; then
            echo "| Severity | Count |" >> security-hardening-report.md
            echo "|----------|-------|" >> security-hardening-report.md
            [ $ERROR_COUNT -gt 0 ] && echo "| üî¥ Error | $ERROR_COUNT |" >> security-hardening-report.md
            [ $WARNING_COUNT -gt 0 ] && echo "| üü† Warning | $WARNING_COUNT |" >> security-hardening-report.md
            [ $INFO_COUNT -gt 0 ] && echo "| üîµ Info | $INFO_COUNT |" >> security-hardening-report.md
            echo "" >> security-hardening-report.md
          fi

          echo "**üìÅ Artifacts:** [OpenGrep Reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)" >> security-hardening-report.md
        else
          echo "**Status:** ‚è≠Ô∏è Skipped" >> security-hardening-report.md
        fi

        echo "" >> security-hardening-report.md
        echo "</details>" >> security-hardening-report.md
        echo "" >> security-hardening-report.md
      continue-on-error: true

    - name: Parse Bandit results
      if: needs.scan-coordinator.outputs.run_bandit == 'true'
      run: |
        echo "<details>" >> security-hardening-report.md
        echo "<summary>üîç Bandit</summary>" >> security-hardening-report.md
        echo "" >> security-hardening-report.md

        if [ -d "bandit-reports" ]; then
          echo "**Status:** ‚úÖ Completed" >> security-hardening-report.md
          echo "" >> security-hardening-report.md

          # Count issues from SARIF files
          ISSUE_COUNT=0
          HIGH_COUNT=0
          MEDIUM_COUNT=0
          LOW_COUNT=0

          for sarif_file in $(find ./bandit-reports -name "*.sarif" -type f 2>/dev/null); do
            if [ -f "$sarif_file" ] && [ -s "$sarif_file" ] && command -v jq >/dev/null 2>&1; then
              issues=$(jq -r '.runs[]?.results[]? | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              ISSUE_COUNT=$((ISSUE_COUNT + issues))

              high=$(jq -r '.runs[]?.results[]? | select(.level == "error" or .level == "warning") | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              HIGH_COUNT=$((HIGH_COUNT + high))

              medium=$(jq -r '.runs[]?.results[]? | select(.level == "note") | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              MEDIUM_COUNT=$((MEDIUM_COUNT + medium))

              low=$(jq -r '.runs[]?.results[]? | select(.level == "info") | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              LOW_COUNT=$((LOW_COUNT + low))
            fi
          done

          echo "**Issues Found:** $ISSUE_COUNT" >> security-hardening-report.md
          echo "" >> security-hardening-report.md

          if [ $ISSUE_COUNT -gt 0 ]; then
            echo "| Severity | Count |" >> security-hardening-report.md
            echo "|----------|-------|" >> security-hardening-report.md
            [ $HIGH_COUNT -gt 0 ] && echo "| üü† High | $HIGH_COUNT |" >> security-hardening-report.md
            [ $MEDIUM_COUNT -gt 0 ] && echo "| üü° Medium | $MEDIUM_COUNT |" >> security-hardening-report.md
            [ $LOW_COUNT -gt 0 ] && echo "| üîµ Low | $LOW_COUNT |" >> security-hardening-report.md
            echo "" >> security-hardening-report.md
          fi

          echo "**üìÅ Artifacts:** [Bandit Reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)" >> security-hardening-report.md
        else
          echo "**Status:** ‚è≠Ô∏è Skipped" >> security-hardening-report.md
        fi

        echo "" >> security-hardening-report.md
        echo "</details>" >> security-hardening-report.md
        echo "" >> security-hardening-report.md
      continue-on-error: true

    - name: Parse GitLeaks results
      if: needs.scan-coordinator.outputs.run_gitleaks == 'true'
      run: |
        echo "<details>" >> security-hardening-report.md
        echo "<summary>üîç GitLeaks</summary>" >> security-hardening-report.md
        echo "" >> security-hardening-report.md

        if [ -d "gitleaks-reports" ]; then
          echo "**Status:** ‚úÖ Completed" >> security-hardening-report.md
          echo "" >> security-hardening-report.md

          # Count secrets from SARIF files
          SECRET_COUNT=0

          for sarif_file in $(find ./gitleaks-reports -name "*.sarif" -type f 2>/dev/null); do
            if [ -f "$sarif_file" ] && [ -s "$sarif_file" ] && command -v jq >/dev/null 2>&1; then
              secrets=$(jq -r '.runs[]?.results[]? | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              SECRET_COUNT=$((SECRET_COUNT + secrets))
            fi
          done

          echo "**Secrets Found:** $SECRET_COUNT" >> security-hardening-report.md
          echo "" >> security-hardening-report.md

          if [ $SECRET_COUNT -gt 0 ]; then
            echo "‚ö†Ô∏è **WARNING:** Potential secrets detected in your repository!" >> security-hardening-report.md
            echo "" >> security-hardening-report.md
          fi

          echo "**üìÅ Artifacts:** [GitLeaks Reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)" >> security-hardening-report.md
        else
          echo "**Status:** ‚è≠Ô∏è Skipped" >> security-hardening-report.md
        fi

        echo "" >> security-hardening-report.md
        echo "</details>" >> security-hardening-report.md
        echo "" >> security-hardening-report.md
      continue-on-error: true

    - name: Parse Container scan results
      if: needs.scan-coordinator.outputs.run_container == 'true'
      run: |
        echo "<details>" >> security-hardening-report.md
        echo "<summary>üîç Container Security</summary>" >> security-hardening-report.md
        echo "" >> security-hardening-report.md

        if compgen -G "container-scan-results-*" > /dev/null 2>&1; then
          echo "**Status:** ‚úÖ Completed" >> security-hardening-report.md
          echo "" >> security-hardening-report.md

          # Count vulnerabilities from SARIF files
          VULN_COUNT=0
          CRITICAL_COUNT=0
          HIGH_COUNT=0
          MEDIUM_COUNT=0
          LOW_COUNT=0

          for sarif_file in $(find . -path "./container-scan-results-*" -name "*.sarif" -type f 2>/dev/null); do
            if [ -f "$sarif_file" ] && [ -s "$sarif_file" ] && command -v jq >/dev/null 2>&1; then
              vulns=$(jq -r '.runs[]?.results[]? | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              VULN_COUNT=$((VULN_COUNT + vulns))

              critical=$(jq -r '.runs[]?.results[]? | select(.level == "error") | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              CRITICAL_COUNT=$((CRITICAL_COUNT + critical))

              high=$(jq -r '.runs[]?.results[]? | select(.level == "warning") | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              HIGH_COUNT=$((HIGH_COUNT + high))

              medium=$(jq -r '.runs[]?.results[]? | select(.level == "note") | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              MEDIUM_COUNT=$((MEDIUM_COUNT + medium))

              low=$(jq -r '.runs[]?.results[]? | select(.level == "info") | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              LOW_COUNT=$((LOW_COUNT + low))
            fi
          done

          echo "**Vulnerabilities Found:** $VULN_COUNT" >> security-hardening-report.md
          echo "" >> security-hardening-report.md

          if [ $VULN_COUNT -gt 0 ]; then
            echo "| Severity | Count |" >> security-hardening-report.md
            echo "|----------|-------|" >> security-hardening-report.md
            [ $CRITICAL_COUNT -gt 0 ] && echo "| üî¥ Critical | $CRITICAL_COUNT |" >> security-hardening-report.md
            [ $HIGH_COUNT -gt 0 ] && echo "| üü† High | $HIGH_COUNT |" >> security-hardening-report.md
            [ $MEDIUM_COUNT -gt 0 ] && echo "| üü° Medium | $MEDIUM_COUNT |" >> security-hardening-report.md
            [ $LOW_COUNT -gt 0 ] && echo "| üîµ Low | $LOW_COUNT |" >> security-hardening-report.md
            echo "" >> security-hardening-report.md
          fi

          echo "**üìÅ Artifacts:** [Container Scan Reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)" >> security-hardening-report.md
        else
          echo "**Status:** ‚è≠Ô∏è Skipped" >> security-hardening-report.md
        fi

        echo "" >> security-hardening-report.md
        echo "</details>" >> security-hardening-report.md
        echo "" >> security-hardening-report.md
      continue-on-error: true

    - name: Parse Infrastructure scan results
      if: needs.scan-coordinator.outputs.run_infrastructure == 'true'
      run: |
        echo "<details>" >> security-hardening-report.md
        echo "<summary>üîç Infrastructure Security</summary>" >> security-hardening-report.md
        echo "" >> security-hardening-report.md

        if [ -d "infrastructure-security-reports" ]; then
          echo "**Status:** ‚úÖ Completed" >> security-hardening-report.md
          echo "" >> security-hardening-report.md

          # Count issues from SARIF files
          ISSUE_COUNT=0
          HIGH_COUNT=0
          MEDIUM_COUNT=0
          LOW_COUNT=0

          for sarif_file in $(find ./infrastructure-security-reports -name "*.sarif" -type f 2>/dev/null); do
            if [ -f "$sarif_file" ] && [ -s "$sarif_file" ] && command -v jq >/dev/null 2>&1; then
              issues=$(jq -r '.runs[]?.results[]? | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              ISSUE_COUNT=$((ISSUE_COUNT + issues))

              high=$(jq -r '.runs[]?.results[]? | select(.level == "error" or .level == "warning") | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              HIGH_COUNT=$((HIGH_COUNT + high))

              medium=$(jq -r '.runs[]?.results[]? | select(.level == "note") | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              MEDIUM_COUNT=$((MEDIUM_COUNT + medium))

              low=$(jq -r '.runs[]?.results[]? | select(.level == "info") | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              LOW_COUNT=$((LOW_COUNT + low))
            fi
          done

          echo "**Issues Found:** $ISSUE_COUNT" >> security-hardening-report.md
          echo "" >> security-hardening-report.md

          if [ $ISSUE_COUNT -gt 0 ]; then
            echo "| Severity | Count |" >> security-hardening-report.md
            echo "|----------|-------|" >> security-hardening-report.md
            [ $HIGH_COUNT -gt 0 ] && echo "| üü† High | $HIGH_COUNT |" >> security-hardening-report.md
            [ $MEDIUM_COUNT -gt 0 ] && echo "| üü° Medium | $MEDIUM_COUNT |" >> security-hardening-report.md
            [ $LOW_COUNT -gt 0 ] && echo "| üîµ Low | $LOW_COUNT |" >> security-hardening-report.md
            echo "" >> security-hardening-report.md
          fi

          echo "**üìÅ Artifacts:** [Infrastructure Reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)" >> security-hardening-report.md
        else
          echo "**Status:** ‚è≠Ô∏è Skipped" >> security-hardening-report.md
        fi

        echo "" >> security-hardening-report.md
        echo "</details>" >> security-hardening-report.md
        echo "" >> security-hardening-report.md
      continue-on-error: true

    - name: Generate overall summary
      run: |
        echo "## üìä Overall Security Score" >> security-hardening-report.md
        echo "" >> security-hardening-report.md

        # Calculate total issues across all scanners
        TOTAL_ISSUES=0
        if command -v jq >/dev/null 2>&1; then
          # Count SARIF issues
          for sarif_file in $(find . -name "*.sarif" -type f 2>/dev/null); do
            if [ -f "$sarif_file" ] && [ -s "$sarif_file" ]; then
              issues=$(jq -r '.runs[]?.results[]? | .ruleId' "$sarif_file" 2>/dev/null | wc -l | tr -d ' ')
              TOTAL_ISSUES=$((TOTAL_ISSUES + issues))
            fi
          done

          # Count OpenGrep JSON issues
          for json_file in $(find ./opengrep-reports -name "*.json" -type f 2>/dev/null); do
            if [ -f "$json_file" ] && [ -s "$json_file" ]; then
              issues=$(jq -r '.results[]? | .check_id' "$json_file" 2>/dev/null | wc -l | tr -d ' ')
              TOTAL_ISSUES=$((TOTAL_ISSUES + issues))
            fi
          done
        fi

        echo "**Total Issues Found:** $TOTAL_ISSUES" >> security-hardening-report.md
        echo "" >> security-hardening-report.md

        if [ "$TOTAL_ISSUES" -eq 0 ]; then
          echo "‚úÖ **Excellent!** No security issues detected." >> security-hardening-report.md
        elif [ "$TOTAL_ISSUES" -lt 5 ]; then
          echo "üü° **Good** - Few issues found, review recommended." >> security-hardening-report.md
        else
          echo "üî¥ **Attention Required** - Multiple security issues found." >> security-hardening-report.md
        fi

        echo "" >> security-hardening-report.md
        echo "## üìã Next Steps" >> security-hardening-report.md
        echo "1. Review the detailed scanner results in the collapsible sections above" >> security-hardening-report.md
        echo "2. Download and review security reports from workflow artifacts" >> security-hardening-report.md
        echo "3. Address any critical or high-severity findings" >> security-hardening-report.md
        echo "4. Consider enabling automated dependency updates" >> security-hardening-report.md

    - name: Capture job run id
      id: job_id
      uses: actions/github-script@v8
      with:
        result-encoding: string
        script: |
          const { owner, repo } = context.repo;
          const runId = context.runId;
          const attempt = context.runAttempt ?? 1;

          const { data } = await github.rest.actions.listJobsForWorkflowRunAttempt({
            owner,
            repo,
            run_id: runId,
            attempt_number: attempt,
            per_page: 100,
          });

          // Debug: Log all job names
          core.info(`Found ${data.jobs.length} jobs in workflow run:`);
          data.jobs.forEach(job => {
            core.info(`  - Job: "${job.name}" (ID: ${job.id}, Status: ${job.status})`);
          });

          const candidates = data.jobs.filter(job => {
            const name = job.name ?? '';
            return name === 'Security Hardening Summary'
              || name.endsWith('/ Security Hardening Summary')
              || name.includes('Security Hardening Summary');
          });

          core.info(`Found ${candidates.length} candidate jobs matching 'Security Hardening Summary'`);

          const inProgress = candidates.filter(job => {
            const status = (job.status || '').toLowerCase();
            return status === 'in_progress' || status === 'queued';
          });

          const orderedCandidates = [...candidates].sort((a, b) => {
            const aTime = a.started_at ? new Date(a.started_at).getTime() : 0;
            const bTime = b.started_at ? new Date(b.started_at).getTime() : 0;

            if (aTime !== bTime) {
              return bTime - aTime;
            }

            const aId = typeof a.id === 'number' ? a.id : 0;
            const bId = typeof b.id === 'number' ? b.id : 0;
            return bId - aId;
          });

          const summaryJob = inProgress[0] ?? orderedCandidates[0];
          const artifactName = summaryJob
            ? `security-hardening-report-${summaryJob.id}`
            : `security-hardening-report-${runId}-attempt${attempt}`;

          if (!summaryJob) {
            core.warning('Security Hardening Summary job not found; falling back to run-based artifact naming.');
          } else {
            core.info(`Security Hardening Summary job resolved to ID ${summaryJob.id} (${summaryJob.name}).`);
          }

          core.exportVariable('SECURITY_HARDENING_REPORT_ARTIFACT', artifactName);
          return artifactName;

    - name: Upload comprehensive security report
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.job_id.outputs.result }}
        path: security-hardening-report.md
        retention-days: 30

    - name: Comment PR with security summary
      if: github.event_name == 'pull_request' && (inputs.post_pr_comment == true || inputs.post_pr_comment == null)
      uses: actions/github-script@v8
      continue-on-error: true
      with:
        script: |
          const fs = require('fs');

          console.log('Repository:', context.repo.owner + '/' + context.repo.repo);
          console.log('Event name:', context.eventName);
          console.log('PR number:', context.issue?.number);

          try {
            const report = fs.readFileSync('security-hardening-report.md', 'utf8');
            const summary = report.length > 65000 ?
              report.substring(0, 65000) + '\n\n... (report truncated, download full report from artifacts)' :
              report;

            const commentBody = `## üõ°Ô∏è Security Hardening Pipeline Results\n\n<!-- security-hardening-comment-marker -->\n\n${summary}`;

            // Check for existing security hardening comments to update instead of creating new ones
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            console.log('üîç Found', comments.data.length, 'existing comments');

            const existingComment = comments.data.find(comment => {
              const hasMarker = comment.body.includes('security-hardening-comment-marker');
              const isGitHubActions = comment.user.login === 'github-actions[bot]' || comment.user.type === 'Bot';
              console.log('Comment from', comment.user.login, 'type:', comment.user.type, 'has marker:', hasMarker);
              return hasMarker && isGitHubActions;
            });

            if (existingComment) {
              // Update existing comment with latest information
              console.log('üîÑ Updating existing security hardening comment');
              const timestamp = new Date().toLocaleString();
              const commitSha = context.sha.substring(0, 8);
              const updatedBody = commentBody + `\n\n---\n*Last updated: ${timestamp} | Commit: ${commitSha} | [View Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*`;

              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: updatedBody
              });
            } else {
              // Create new comment
              console.log('üìù Creating new security hardening comment');
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            }

            console.log('‚úÖ Successfully posted/updated security hardening summary comment');
          } catch (error) {
            console.log('‚ùå Failed to post security summary comment:', error.message);
            console.log('Error status:', error.status);

            if (error.status === 403) {
              console.log('üîí Permission denied - this can happen when:');
              console.log('   ‚Ä¢ Running on a fork (security restriction)');
              console.log('   ‚Ä¢ Missing pull-requests: write permission');
              console.log('   ‚Ä¢ Repository settings restrict PR comments');
            } else if (error.status === 404) {
              console.log('üîç Resource not found - check if PR exists');
            }

            console.log('üìã Security hardening report is still available in workflow artifacts');
          }
