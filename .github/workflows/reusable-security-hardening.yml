name: Reusable Security Hardening Pipeline

on:
  workflow_call:
    inputs:
      scan_type:
        description: 'Type of security scan to run (full, sast-only, codeql-only, container-only, infrastructure-only)'
        required: false
        default: 'full'
        type: string
      python_version:
        description: 'Python version to use'
        required: false
        default: '3.12'
        type: string
      aws_region:
        description: 'AWS region for infrastructure scans'
        required: false
        default: 'us-east-1'
        type: string
      post_pr_comment:
        description: 'Whether to post PR comments'
        required: false
        default: true
        type: boolean
      codeql_languages:
        description: 'Comma-separated list of languages for CodeQL analysis (e.g., "python,javascript" or "python")'
        required: false
        default: 'python,javascript'
        type: string
      # Granular scanner controls (when not specified, scan_type determines behavior)
      enable_codeql:
        description: 'Enable CodeQL scanner (overrides scan_type when explicitly set)'
        required: false
        type: boolean
      enable_semgrep:
        description: 'Enable Semgrep scanner (overrides scan_type when explicitly set)'
        required: false
        type: boolean
      enable_bandit:
        description: 'Enable Bandit scanner (overrides scan_type when explicitly set)'
        required: false
        type: boolean
      enable_gitleaks:
        description: 'Enable Gitleaks scanner (overrides scan_type when explicitly set)'
        required: false
        type: boolean
      skip_linting:
        description: 'Skip linting checks (useful when linting already ran in parent workflow)'
        required: false
        default: false
        type: boolean
    secrets:
      AWS_ACCOUNT_ID:
        description: 'AWS Account ID for infrastructure scans'
        required: false

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write
  checks: write
  id-token: write

env:
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  AWS_REGION: ${{ inputs.aws_region }}
  PYTHON_VERSION: ${{ inputs.python_version }}

jobs:
  # Run linting first to catch basic code quality issues (unless skipped)
  code-quality-linting:
    name: Code Quality & Linting
    if: ${{ !inputs.skip_linting }}
    uses: ./.github/workflows/linting.yml
    permissions:
      contents: read
      pull-requests: write
      checks: write

  scan-coordinator:
    name: Scan Coordinator
    runs-on: ubuntu-latest
    needs: [code-quality-linting]
    if: ${{ always() && !cancelled() }}
    outputs:
      scan_type: ${{ steps.determine-scan.outputs.scan_type }}
      should_run_sast: ${{ steps.determine-scan.outputs.should_run_sast }}
      should_run_container: ${{ steps.determine-scan.outputs.should_run_container }}
      should_run_infrastructure: ${{ steps.determine-scan.outputs.should_run_infrastructure }}
      # Granular scanner outputs
      should_run_codeql: ${{ steps.determine-scan.outputs.should_run_codeql }}
      should_run_semgrep: ${{ steps.determine-scan.outputs.should_run_semgrep }}
      should_run_bandit: ${{ steps.determine-scan.outputs.should_run_bandit }}
      should_run_gitleaks: ${{ steps.determine-scan.outputs.should_run_gitleaks }}
      linting_status: ${{ needs.code-quality-linting.outputs.linting_status }}
      linting_issues: ${{ needs.code-quality-linting.outputs.issues_found }}

    steps:
    - name: Determine scan type
      id: determine-scan
      run: |
        SCAN_TYPE="${{ inputs.scan_type }}"
        if [ -z "$SCAN_TYPE" ]; then
          SCAN_TYPE="full"
        fi

        echo "scan_type=$SCAN_TYPE" >> $GITHUB_OUTPUT

        # Display linting results
        LINTING_STATUS="${{ needs.code-quality-linting.outputs.linting_status }}"
        LINTING_ISSUES="${{ needs.code-quality-linting.outputs.issues_found }}"

        echo "ğŸ“Š Code Quality Summary:"
        echo "Linting Status: $LINTING_STATUS"
        echo "Issues Found: $LINTING_ISSUES"

        if [ "$LINTING_ISSUES" != "0" ] && [ -n "$LINTING_ISSUES" ]; then
          echo "::warning title=Code Quality Issues::Found $LINTING_ISSUES linting issues. Security scans will continue."
        fi

        # Initialize defaults based on scan_type
        case "$SCAN_TYPE" in
          "full")
            echo "should_run_sast=true" >> $GITHUB_OUTPUT
            echo "should_run_container=true" >> $GITHUB_OUTPUT
            echo "should_run_infrastructure=true" >> $GITHUB_OUTPUT
            # For full scan, enable all SAST scanners by default
            DEFAULT_CODEQL=true
            DEFAULT_SEMGREP=true
            DEFAULT_BANDIT=true
            DEFAULT_GITLEAKS=true
            ;;
          "sast-only")
            echo "should_run_sast=true" >> $GITHUB_OUTPUT
            echo "should_run_container=false" >> $GITHUB_OUTPUT
            echo "should_run_infrastructure=false" >> $GITHUB_OUTPUT
            # For SAST-only, enable all SAST scanners by default
            DEFAULT_CODEQL=true
            DEFAULT_SEMGREP=true
            DEFAULT_BANDIT=true
            DEFAULT_GITLEAKS=true
            ;;
          "codeql-only")
            echo "should_run_sast=false" >> $GITHUB_OUTPUT
            echo "should_run_container=false" >> $GITHUB_OUTPUT
            echo "should_run_infrastructure=false" >> $GITHUB_OUTPUT
            # For CodeQL-only, only enable CodeQL
            DEFAULT_CODEQL=true
            DEFAULT_SEMGREP=false
            DEFAULT_BANDIT=false
            DEFAULT_GITLEAKS=false
            ;;
          "container-only")
            echo "should_run_sast=false" >> $GITHUB_OUTPUT
            echo "should_run_container=true" >> $GITHUB_OUTPUT
            echo "should_run_infrastructure=false" >> $GITHUB_OUTPUT
            # No SAST scanners for container-only
            DEFAULT_CODEQL=false
            DEFAULT_SEMGREP=false
            DEFAULT_BANDIT=false
            DEFAULT_GITLEAKS=false
            ;;
          "infrastructure-only")
            echo "should_run_sast=false" >> $GITHUB_OUTPUT
            echo "should_run_container=false" >> $GITHUB_OUTPUT
            echo "should_run_infrastructure=true" >> $GITHUB_OUTPUT
            # No SAST scanners for infrastructure-only
            DEFAULT_CODEQL=false
            DEFAULT_SEMGREP=false
            DEFAULT_BANDIT=false
            DEFAULT_GITLEAKS=false
            ;;
          *)
            echo "::warning title=Unknown Scan Type::Unknown scan type '$SCAN_TYPE', defaulting to 'full'"
            echo "should_run_sast=true" >> $GITHUB_OUTPUT
            echo "should_run_container=true" >> $GITHUB_OUTPUT
            echo "should_run_infrastructure=true" >> $GITHUB_OUTPUT
            DEFAULT_CODEQL=true
            DEFAULT_SEMGREP=true
            DEFAULT_BANDIT=true
            DEFAULT_GITLEAKS=true
            ;;
        esac

        # Apply granular scanner overrides (if explicitly set)
        ENABLE_CODEQL="${{ inputs.enable_codeql }}"
        ENABLE_SEMGREP="${{ inputs.enable_semgrep }}"
        ENABLE_BANDIT="${{ inputs.enable_bandit }}"
        ENABLE_GITLEAKS="${{ inputs.enable_gitleaks }}"

        # Use explicit inputs if provided, otherwise use defaults
        if [ "$ENABLE_CODEQL" = "true" ] || [ "$ENABLE_CODEQL" = "false" ]; then
          echo "should_run_codeql=$ENABLE_CODEQL" >> $GITHUB_OUTPUT
        else
          echo "should_run_codeql=$DEFAULT_CODEQL" >> $GITHUB_OUTPUT
        fi

        if [ "$ENABLE_SEMGREP" = "true" ] || [ "$ENABLE_SEMGREP" = "false" ]; then
          echo "should_run_semgrep=$ENABLE_SEMGREP" >> $GITHUB_OUTPUT
        else
          echo "should_run_semgrep=$DEFAULT_SEMGREP" >> $GITHUB_OUTPUT
        fi

        if [ "$ENABLE_BANDIT" = "true" ] || [ "$ENABLE_BANDIT" = "false" ]; then
          echo "should_run_bandit=$ENABLE_BANDIT" >> $GITHUB_OUTPUT
        else
          echo "should_run_bandit=$DEFAULT_BANDIT" >> $GITHUB_OUTPUT
        fi

        if [ "$ENABLE_GITLEAKS" = "true" ] || [ "$ENABLE_GITLEAKS" = "false" ]; then
          echo "should_run_gitleaks=$ENABLE_GITLEAKS" >> $GITHUB_OUTPUT
        else
          echo "should_run_gitleaks=$DEFAULT_GITLEAKS" >> $GITHUB_OUTPUT
        fi

        # Display configuration summary
        echo ""
        echo "ğŸ”§ Scan Configuration:"
        echo "  Scan Type: $SCAN_TYPE"
        echo "  SAST Pipeline: $(grep 'should_run_sast=' $GITHUB_OUTPUT | cut -d= -f2)"
        echo "  Container Pipeline: $(grep 'should_run_container=' $GITHUB_OUTPUT | cut -d= -f2)"
        echo "  Infrastructure Pipeline: $(grep 'should_run_infrastructure=' $GITHUB_OUTPUT | cut -d= -f2)"
        echo ""
        echo "ğŸ” Individual Scanners:"
        echo "  CodeQL: $(grep 'should_run_codeql=' $GITHUB_OUTPUT | cut -d= -f2)"
        echo "  Semgrep: $(grep 'should_run_semgrep=' $GITHUB_OUTPUT | cut -d= -f2)"
        echo "  Bandit: $(grep 'should_run_bandit=' $GITHUB_OUTPUT | cut -d= -f2)"
        echo "  Gitleaks: $(grep 'should_run_gitleaks=' $GITHUB_OUTPUT | cut -d= -f2)"

  # SAST pipeline - runs when should_run_sast is true OR when any individual scanner is enabled
  run-sast-pipeline:
    name: SAST Security Pipeline
    needs: scan-coordinator
    if: |
      needs.scan-coordinator.outputs.should_run_sast == 'true' ||
      needs.scan-coordinator.outputs.should_run_codeql == 'true' ||
      needs.scan-coordinator.outputs.should_run_semgrep == 'true' ||
      needs.scan-coordinator.outputs.should_run_bandit == 'true' ||
      needs.scan-coordinator.outputs.should_run_gitleaks == 'true'
    uses: ./.github/workflows/sast.yml
    with:
      post_pr_comment: ${{ inputs.post_pr_comment }}
      codeql_languages: ${{ inputs.codeql_languages }}
    permissions:
      contents: read
      security-events: write
      actions: read
      pull-requests: write
    secrets: inherit

  run-container-pipeline:
    name: Trigger Container Security Pipeline
    needs: scan-coordinator
    if: needs.scan-coordinator.outputs.should_run_container == 'true'
    uses: ./.github/workflows/container-scan.yml
    with:
      post_pr_comment: ${{ inputs.post_pr_comment }}
    permissions:
      contents: read
      security-events: write
      actions: read
      pull-requests: write
    secrets: inherit

  infrastructure-security:
    name: Infrastructure Security Analysis
    runs-on: ubuntu-latest
    needs: scan-coordinator
    if: needs.scan-coordinator.outputs.should_run_infrastructure == 'true'
    timeout-minutes: 20
    continue-on-error: true

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ inputs.python_version }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Install security tools
      run: |
        pip install checkov
        curl -L "$(curl -s https://api.github.com/repos/tenable/terrascan/releases/latest | grep -o -E "https://.+?_Linux_x86_64.tar.gz")" > terrascan.tar.gz
        tar -xf terrascan.tar.gz terrascan && rm terrascan.tar.gz
        sudo mv terrascan /usr/local/bin
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update && sudo apt-get install -y trivy

    - name: Run Infrastructure Security Scans
      run: |
        if [ -d "infrastructure" ]; then
          cd infrastructure
          echo "ğŸ” Running Trivy infrastructure security scan..."
          trivy config --format sarif --output trivy-results.sarif . || true

          echo "ğŸ—ï¸ Running Checkov infrastructure security scan..."
          checkov -d . --framework terraform --output sarif --output-file-path checkov-results.sarif || true

          echo "ğŸ”§ Running Terrascan infrastructure security scan..."
          terrascan scan -i terraform -t all -d . --sarif-output terrascan-results.sarif || true
        else
          echo "No infrastructure directory found, skipping infrastructure scans"
        fi
      continue-on-error: true

    - name: Upload Infrastructure Security Results
      uses: github/codeql-action/upload-sarif@v3
      if: always() && github.actor != 'nektos/act'
      with:
        sarif_file: infrastructure/*.sarif
      continue-on-error: true

  security-summary:
    name: Security Hardening Summary
    runs-on: ubuntu-latest
    needs: [
      scan-coordinator,
      run-sast-pipeline,
      run-container-pipeline,
      infrastructure-security
    ]
    if: always()

    steps:
    - name: Download all security artifacts
      uses: actions/download-artifact@v5
      continue-on-error: true

    - name: Create comprehensive security report
      run: |
        echo "# ğŸ›¡ï¸ Security Analysis Summary" > security-hardening-report.md
        echo "" >> security-hardening-report.md
        echo "**Repository:** ${{ github.repository }}" >> security-hardening-report.md
        echo "**Branch:** ${{ github.ref_name }}" >> security-hardening-report.md
        echo "**Generated:** $(date)" >> security-hardening-report.md
        echo "" >> security-hardening-report.md

        # Count security issues from SARIF files
        TOTAL_ISSUES=0
        if command -v jq >/dev/null 2>&1; then
          for sarif_file in $(find . -name "*.sarif" 2>/dev/null); do
            if [ -f "$sarif_file" ] && [ -s "$sarif_file" ]; then
              issues=$(jq -r '.runs[]?.results[]? | .ruleId' "$sarif_file" 2>/dev/null | wc -l || echo 0)
              TOTAL_ISSUES=$((TOTAL_ISSUES + issues))
            fi
          done
        fi

        echo "## ğŸ“Š Security Score" >> security-hardening-report.md
        echo "" >> security-hardening-report.md
        echo "**Total Issues Found:** $TOTAL_ISSUES" >> security-hardening-report.md
        echo "" >> security-hardening-report.md

        if [ "$TOTAL_ISSUES" -eq 0 ]; then
          echo "âœ… **Excellent!** No security issues detected." >> security-hardening-report.md
        elif [ "$TOTAL_ISSUES" -lt 5 ]; then
          echo "ğŸŸ¡ **Good** - Few issues found, review recommended." >> security-hardening-report.md
        else
          echo "ğŸ”´ **Attention Required** - Multiple security issues found." >> security-hardening-report.md
        fi

        echo "" >> security-hardening-report.md
        echo "## ğŸ“‹ Next Steps" >> security-hardening-report.md
        echo "1. Download and review security reports from workflow artifacts" >> security-hardening-report.md
        echo "2. Address any critical or high-severity findings" >> security-hardening-report.md
        echo "3. Consider enabling automated dependency updates" >> security-hardening-report.md

    - name: Upload comprehensive security report
      uses: actions/upload-artifact@v4
      with:
        name: security-hardening-report
        path: security-hardening-report.md
        retention-days: 90

    - name: Comment PR with security summary
      if: github.event_name == 'pull_request' && (inputs.post_pr_comment == true || inputs.post_pr_comment == null)
      uses: actions/github-script@v8
      continue-on-error: true
      with:
        script: |
          const fs = require('fs');

          console.log('Repository:', context.repo.owner + '/' + context.repo.repo);
          console.log('Event name:', context.eventName);
          console.log('PR number:', context.issue?.number);

          try {
            const report = fs.readFileSync('security-hardening-report.md', 'utf8');
            const summary = report.length > 65000 ?
              report.substring(0, 65000) + '\n\n... (report truncated, download full report from artifacts)' :
              report;

            const commentBody = `## ğŸ›¡ï¸ Security Hardening Pipeline Results\n\n<!-- security-hardening-comment-marker -->\n\n${summary}`;

            // Check for existing security hardening comments to update instead of creating new ones
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            console.log('ğŸ” Found', comments.data.length, 'existing comments');

            const existingComment = comments.data.find(comment => {
              const hasMarker = comment.body.includes('security-hardening-comment-marker');
              const isGitHubActions = comment.user.login === 'github-actions[bot]' || comment.user.type === 'Bot';
              console.log('Comment from', comment.user.login, 'type:', comment.user.type, 'has marker:', hasMarker);
              return hasMarker && isGitHubActions;
            });

            if (existingComment) {
              // Update existing comment with latest information
              console.log('ğŸ”„ Updating existing security hardening comment');
              const timestamp = new Date().toLocaleString();
              const commitSha = context.sha.substring(0, 8);
              const updatedBody = commentBody + `\n\n---\n*Last updated: ${timestamp} | Commit: ${commitSha} | [View Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*`;

              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: updatedBody
              });
            } else {
              // Create new comment
              console.log('ğŸ“ Creating new security hardening comment');
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            }

            console.log('âœ… Successfully posted/updated security hardening summary comment');
          } catch (error) {
            console.log('âŒ Failed to post security summary comment:', error.message);
            console.log('Error status:', error.status);

            if (error.status === 403) {
              console.log('ğŸ”’ Permission denied - this can happen when:');
              console.log('   â€¢ Running on a fork (security restriction)');
              console.log('   â€¢ Missing pull-requests: write permission');
              console.log('   â€¢ Repository settings restrict PR comments');
            } else if (error.status === 404) {
              console.log('ğŸ” Resource not found - check if PR exists');
            }

            console.log('ğŸ“‹ Security hardening report is still available in workflow artifacts');
          }
