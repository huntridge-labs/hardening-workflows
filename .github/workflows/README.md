# Security Hardening Workflows

This directory contains comprehensive security workflows for the agentic-automation-vba project, implementing multiple layers of security scanning and analysis.

## Overview

The security hardening pipeline consists of three main workflows:

1. **SAST (Static Application Security Testing)** - `sast.yml`
2. **Container Security Scanning** - `container-scan.yml`
3. **Comprehensive Security Hardening** - `security-hardening.yml`

## Workflows Description

### 1. SAST Workflow (`sast.yml`)

Performs static code analysis on the codebase to identify security vulnerabilities in source code.

**Tools Used:**
- **CodeQL**: GitHub's semantic code analysis engine
- **OpenGrep**: Fast static analysis for security bugs
- **Bandit**: Python-specific security linter
- **Safety**: Python dependency vulnerability scanner
- **Checkov**: Infrastructure as Code (Terraform) security scanner
- **Hadolint**: Dockerfile security linter
- **Gitleaks**: Secrets detection

**Triggers:**
- Push to `main` or `develop` branches
- Pull requests to `main` or `develop` branches
- Manual trigger (daily schedule commented out to reduce noise)

### 2. Container Security Workflow (`container-scan.yml`)

Scans container images for vulnerabilities and security misconfigurations.

**Tools Used:**
- **Trivy**: Comprehensive vulnerability scanner
- **Grype**: Container image vulnerability scanner
- **AWS ECR Image Scanning**: Native AWS container scanning

**Features:**
- Automatically discovers Lambda Dockerfiles that are deployed
- Smart scanning: Uses pre-built ECR images when available, local build as fallback
- Scans images stored in AWS ECR with native scanning
- Generates multiple report formats (SARIF, JSON, text)
- Optimized for cost efficiency and speed

**Triggers:**
- Push/PR with changes to Dockerfiles or requirements.txt
- Manual trigger (daily schedule commented out to reduce noise)

### 3. Security Hardening Workflow (`security-hardening.yml`)

Orchestrates comprehensive security scanning across the entire project.

**Features:**
- Selective scanning (full, SAST-only, container-only, infrastructure-only)
- Infrastructure security analysis with multiple tools
- AWS security configuration assessment
- License compliance checking
- Comprehensive reporting and notifications

**Tools Used:**
- All SAST and Container tools (via workflow calls) - 100% OSS
- **Trivy**: Infrastructure security scanning (config analysis)
- **Terrascan**: Multi-cloud security scanner
- **pip-licenses**: Python license compliance

## Setup Instructions

### Prerequisites

1. **GitHub Secrets Configuration (Optional)**
   ```
   SLACK_WEBHOOK_URL (optional) - For Slack notifications
   ```

2. **AWS IAM Role (Optional - Only for AWS Security Analysis)**
   - The workflows use OIDC for AWS authentication
   - **Required only if you want AWS security configuration analysis**
   - If not configured, the pipeline will continue without AWS analysis
   - Ensure the `github-oidc-role` has necessary permissions:
     - ECR read access for image scanning
     - Basic AWS resource read permissions for security assessment
   - Update `AWS_ACCOUNT_ID` in the workflow if different from default

3. **No AWS? No Problem!**
   - The hardening pipeline works perfectly without AWS components
   - All security scanning tools (SAST, container scanning, infrastructure analysis) work with any codebase
   - AWS analysis is only triggered for infrastructure scans on the main branch

### Configuration

1. **CodeQL Configuration**
   - Custom configuration in `.github/codeql/codeql-config.yml`
   - Excludes test files and focuses on security queries

2. **Workflow Customization**
   - Update branch names in workflow triggers if needed
   - Modify Slack channel in notification steps
   - Adjust scan schedules as required

## Security Artifacts

The workflows generate comprehensive security reports:

### SARIF Files
- Uploaded to GitHub Security tab for centralized vulnerability management
- Compatible with GitHub Advanced Security features

### Artifact Reports
- **SAST Reports**: Bandit, Safety, Checkov, Hadolint, Gitleaks results
- **Container Reports**: Trivy, Grype, AWS ECR scan results
- **Infrastructure Reports**: Trivy, Terrascan, Checkov results
- **License Reports**: pip-licenses compliance reports
- **Security Summary**: Comprehensive overview report

**Note**: All reports generated by open-source tools only

## Usage

### Manual Execution

Run security scans manually:

```yaml
# Full security scan
workflow_dispatch:
  inputs:
    scan_type: 'full'

# SAST only
workflow_dispatch:
  inputs:
    scan_type: 'sast-only'

# Container scanning only
workflow_dispatch:
  inputs:
    scan_type: 'container-only'

# Infrastructure only
workflow_dispatch:
  inputs:
    scan_type: 'infrastructure-only'
```

### Viewing Results

1. **GitHub Security Tab**: View SARIF results for all security findings
2. **Workflow Artifacts**: Download detailed reports from workflow runs
3. **PR Comments**: Automatic security summaries on pull requests
4. **Slack Notifications**: Real-time alerts for security issues

## Security Baseline

### Critical Security Controls

1. **Supply Chain Security**
   - Dependency vulnerability scanning (Safety)
   - License compliance checking
   - Container base image scanning

2. **Code Security**
   - Static analysis for security bugs (CodeQL, OpenGrep, Bandit)
   - Secrets detection (Gitleaks)
   - Infrastructure as Code scanning (Checkov, Trivy)

3. **Runtime Security**
   - Container vulnerability scanning
   - AWS security configuration analysis
   - Regular security assessments

### Compliance Features

- **SARIF Support**: Industry-standard security report format
- **Audit Trail**: All security scans logged and tracked
- **Automated Remediation**: Integration with dependency update tools
- **Continuous Monitoring**: Scheduled daily/weekly scans

## Troubleshooting

### Common Issues

1. **CodeQL Analysis Timeout**
   - Increase timeout in workflow if needed
   - Exclude unnecessary paths in CodeQL config

2. **Container Build Failures**
   - Check Dockerfile syntax and dependencies
   - Verify base image availability

3. **AWS Credentials Issues**
   - **"Credentials could not be loaded"** - This is expected if you don't have AWS resources
   - The pipeline will continue and generate a report explaining the situation
   - To enable AWS analysis:
     - Set up AWS OIDC role for your repository
     - Update `AWS_ACCOUNT_ID` in the workflow environment variables
     - Ensure the role has read permissions for security analysis
   - **"Missing id-token permission"** - Already fixed in this version

4. **Pull Request Comment Issues**
   - **"Resource not accessible by integration"** - This is expected when:
     - Running from a forked repository (GitHub security restriction)
     - Missing `pull-requests: write` permission (already fixed)
     - Repository settings restrict PR comments
   - The pipeline continues normally and reports are available in artifacts
   - All security scanning results are preserved regardless of commenting issues

5. **Not All Pipelines Need AWS**
   - Many security hardening workflows don't require AWS components
   - SAST, container scanning, and infrastructure analysis work without AWS
   - AWS analysis only runs on main branch for infrastructure scans

### Debug Steps

1. Enable workflow debug logging:
   ```
   ACTIONS_RUNNER_DEBUG: true
   ACTIONS_STEP_DEBUG: true
   ```

2. Review workflow artifacts for detailed logs
3. Check individual tool documentation for specific issues

## Continuous Improvement

### Metrics to Track

- Number of vulnerabilities by severity
- Time to remediation
- Scan coverage and effectiveness
- False positive rates

### Regular Maintenance

- Update security tool versions quarterly
- Review and tune security policies
- Update ignore/allowlist configurations
- Training on new security features

## Contributing

When adding new security tools or configurations:

1. Test changes in feature branches
2. Update documentation
3. Consider impact on scan performance
4. Ensure SARIF compatibility for GitHub integration

## Resources

- [GitHub Advanced Security Documentation](https://docs.github.com/en/code-security)
- [SARIF Specification](https://docs.oasis-open.org/sarif/sarif/v2.1.0/sarif-v2.1.0.html)
- [AWS Security Best Practices](https://aws.amazon.com/security/security-resources/)
- [OWASP Secure Coding Practices](https://owasp.org/www-project-secure-coding-practices-quick-reference-guide/)
